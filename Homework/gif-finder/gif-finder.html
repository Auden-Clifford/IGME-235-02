<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
 	<title>Giphy Finder</title>
 	<link rel="stylesheet" href="styles/main.css">

  <script>
    // 1
  	window.onload = (e) => {document.querySelector("#search").onclick = searchButtonClicked};
	
	// 2
	let displayTerm = "";
	
	// 3
	function searchButtonClicked(){
		console.log("searchButtonClicked() called");

        // save the link to the API
		const GIPHY_URL = "https://api.giphy.com/v1/gifs/search?";

        // save the Giphy key
        let GIPHY_KEY = "5PuWjWVnwpHUQPZK866vd7wQ2qeCeqg7";

        // start building the url string
        let url = `${GIPHY_URL}api_key=${GIPHY_KEY}`;

        // get the search term and get rid of trailing and leading spaces
        let term = document.querySelector("#searchterm").value.trim();
        displayTerm = term;
        
        // encode spaces and special characters
        term = encodeURIComponent(term);

        // ensure there is a term to search
        if(term.length < 1) return;

        //append the search term to the url
        url += "&q=" + term;

        // grab the limit and append it to the URL
        let limit = document.querySelector("#limit").value;
        url += "&limit=" + limit;

        // update UI
        document.querySelector("#status").innerHTML = `<b>Searching for '${displayTerm}'</b>`;

        console.log(url);

        // 12 Request data!
        getData(url);
	}

    function getData(url){
        // create XHR object
        let xhr = new XMLHttpRequest();

        // set onload handler
        xhr.onload = dataLoaded;

        // set onerror handler
        xhr.onerror = dataError;

        // open connection and send the request
        xhr.open("GET", url);
        xhr.send();
    }

    // callback functions
    function dataLoaded(e){
        let xhr = e.target;

        console.log(xhr.responseText);

        // parse the text to a JavaScript object
        let obj = JSON.parse(xhr.responseText);
        
        // print a message and bail if there are no results
        if(!obj.data || obj.data.length == 0){
            document.querySelector("#status").innerHTML = `<b>No results found for '${displayTerm}'</b>`;
            return;
        }

        // start building the HTML string to display
        let results = obj.data;
        console.log("results.length = " + results.length);
        let bigString = `<p><i>Here are ${results.length} results for '${displayTerm}'</i></p>`;

        // loop through the results
        for(let i = 0; i < results.length; i++)
        {
            let result = results[i];

            // get the GIF URL
            let smallURL = result.images.fixed_width_small.url;
            if(!smallURL) smallURL = "images/no-image-found.png";

            // GIPHY page url
            let url = result.url;

            // make a <div> for each result
            let line = `<div class='result'>
                <span><em>Rated: ${result.rating.toUpperCase()}</em></span>
                <img src='${smallURL}' title='${result.id}'/>
                <span><a target='_blank' href='${url}'>View on Giphy</a></span>
                </div>`;
                
            bigString += line;
        }

        // add the new HTML to the content area
        document.querySelector("#content").innerHTML = bigString;

        document.querySelector("#status").innerHTML = "<b>Success!</b>";
    }

    function dataError(e){
        console.log("An error occurred");
    }
	
  </script>

  
</head>
<body>
<header>
	<h1>Giphy Finder</h1>
</header>

<div class="widgets">
	Search Term -> 
	<input id="searchterm" type="text" size="20" maxlength="20" autofocus value="cats" />
</div>

<div class="widgets">
	Max # results -> 
	<select id="limit">
		<option value="5">5</option>
		<option value="10" selected>10</option>
		<option value="25">25</option>
		<option value="50">50</option>
		<option value="100">100</option>
	</select>
</div>

<div class="widgets">
	<button type="button" id="search" class="green">Find some GIFs!<br />:-)</button>
</div>
<div id="status">Ready to Search!</div>
<hr>

<h2>Results</h2>
<div id="content">
	<p>No data yet!</p>
</div>
 

</body>
</html>